name: Pulumi
on:
  push:
      branches: [ "serverless-system" ]

env:
  AWS_REGION: ca-central-1 
  ASSUME_ROLE: arn:aws:iam::516193157210:role/base-app-role

jobs:
  preview:
    name: Preview
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          go-version: 1.18.x
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1.7.0
        with:
          role-to-assume: ${{ env.ASSUME_ROLE }}
          aws-region: ${{ env.AWS_REGION }}
      - run: go mod download
      - uses: pulumi/actions@v3
        with:
          command: preview
          stack-name: iac-codepipeline # When using an individual account, only use stack-name.
          color: always
          work-dir: /serverless-system/iac-pulumi/
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_TOKEN }}